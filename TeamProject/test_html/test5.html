<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>ì§€ë„ í˜ì´ì§€</title>

	<!-- tailwindcss import -->
	<script src="https://cdn.tailwindcss.com"></script>

	<!-- CSS ë§í¬ -->
	<link rel="stylesheet" href="./style.css">

</head>

<body class="flex">

  <!-- ì¢Œì¸¡ ë„¤ë¹„(ë¡œì»¬ ì´ë¯¸ì§€ ì•„ì´ì½˜ ì‚¬ìš©) -->
	<aside class="w-36 bg-[#FFFFFF] border-r flex flex-col justify-between py-4 shadow z-[3000]">
  
    	<!-- í™œì„± ìƒíƒœëŠ” aria-current="page" ë¡œ í‘œì‹œ-->
    	<!-- ìƒë‹¨ ê·¸ë£¹ -->
    	<div class="flex flex-col items-center space-y-6 w-full">

    	<!-- í™ˆ í™”ë©´(ë©”ì¸ ì§€ë„) -->
    	<button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" aria-current="page" data-tab="map" title="ì§€ë„">
        	<img src="./assets/icons/Home.png" alt="ì§€ë„" class="side-icon w-12 h-12"/>
    	</button>
      
    	<!-- ì¶”ì²œ í”¼ë“œ & ê²€ìƒ‰ -->
    	<button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" data-tab="search" title="ê²€ìƒ‰">
        	<img src="./assets/icons/Search.png" alt="ê²€ìƒ‰" class="side-icon w-12 h-12"/>
    	</button>
    
    	<!-- íŒ”ë¡œìš° í”¼ë“œ -->
    	<button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" data-tab="user" title="ì‚¬ìš©ì">
        	<img src="./assets/icons/Compass.png" alt="ì‚¬ìš©ì" class="side-icon w-12 h-12"/>
    	</button>
    
    	<!-- ê°€ê²Œ ìˆœìœ„ -->
    	<button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" data-tab="crown" title="ì™•ê´€">
    		<img src="./assets/icons/Award.png" alt="ì¶”ì²œ" class="side-icon w-12 h-12"/>
    	</button>
    	</div>

    	<!-- í•˜ë‹¨ ê·¸ë£¹ -->
    	<div class="flex flex-col items-center space-y-6 w-full">
      
    	<!-- ë§ˆì´í˜ì´ì§€ -->
    	<button class="side-btn w-36 h-24 flex items-center justify-center hover:bg-[#F8C74D]" data-tab="setting" title="ì„¤ì •">
    		<img src="./assets/icons/User.png" alt="ì„¤ì •" class="side-icon w-12 h-12"/>
    	</button>
    
    	<!-- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ -->
    	<button class="side-btn w-36 h-24 flex items-center justify-center hover:bg-[#F8C74D]" data-tab="logout" title="ë¡œê·¸ì•„ì›ƒ">
    		<img src="./assets/icons/Logout.png" alt="ë¡œê·¸ì•„ì›ƒ" class="side-icon w-12 h-12"/>
    	</button>
    	</div>
	</aside>


	<!-- ì§€ë„ ì˜ì—­ -->
	<main class="flex-1 relative">
    	<div id="status">í˜„ì¬ ìœ„ì¹˜ íŒŒì•… ì¤‘â€¦</div>
    	<button id="loadMore">ë”ë³´ê¸° (20ê°œ)</button>    
    	<div id="map"></div>

    	<!-- ì§€ë„ ìš°ì¸¡ í•˜ë‹¨ ë²„íŠ¼ ê·¸ë£¹ -->
    	<div class="absolute bottom-4 right-4 z-[1000] flex items-center space-x-2 bg-none p-2 rounded-lg text-lg">
    
      		<!-- í•œì‹ -->
      		<button class="food-btn" aria-pressed="false">
        		<span class="icon-wrap">
        			<img src="./assets/map_icons/koreanfood_icon.png" alt="í•œì‹"/>
        		</span>
        		<span>í•œì‹</span>
      		</button>

      		<!-- ì¤‘ì‹ -->
      		<button class="food-btn" aria-pressed="false">
        		<span class="icon-wrap">
        			<img src="./assets/map_icons/chinesefood_icon.png" alt="ì¤‘ì‹"/>
        		</span>
        		<span>ì¤‘ì‹</span>
      		</button>

      		<!-- ì¼ì‹ -->
      		<button class="food-btn" aria-pressed="false">
        		<span class="icon-wrap">
        			<img src="./assets/map_icons/japanesefood_icon.png" alt="ì¼ì‹"/>
        		</span>
        		<span>ì¼ì‹</span>
      		</button>

      		<!-- ì–‘ì‹ -->
      		<button class="food-btn" aria-pressed="false">
        		<span class="icon-wrap">
        			<img src="./assets/map_icons/westernfood_icon.png" alt="ì–‘ì‹"/>
        		</span>
        		<span>ì–‘ì‹</span>
      		</button>

      		<!-- ë¶„ì‹ -->
      		<button class="food-btn" aria-pressed="false">
        		<span class="icon-wrap">
        			<img src="./assets/map_icons/schoolfood_icon.png" alt="ë¶„ì‹"/>
        		</span>
        		<span>ë¶„ì‹</span>
      		</button>


      		<!-- í™•ëŒ€/ì¶•ì†Œ -->
      		<div class="flex flex-col ml-2">
        
        		<!-- ì¤Œì¸ ë²„íŠ¼ -->
        		<button id="zoomIn" class="w-12 h-12 flex items-center justify-center bg-white rounded hover:bg-[#F8C74D] mb-1">+</button>
        
        		<!-- ì¤Œ ì•„ì›ƒ ë²„íŠ¼ -->
        		<button id="zoomOut" class="w-12 h-12 flex items-center justify-center bg-white rounded hover:bg-[#F8C74D] mb-1">-</button>
    
        		<!-- í˜„ì¬ ìœ„ì¹˜ -->
        		<button id="currentLocationBtn" class="w-12 h-12 flex items-center justify-center bg-white rounded hover:bg-[#F8C74D]">
        			<img src="./assets/icons/current_location.png" alt="í˜„ì¬ ìœ„ì¹˜" class="w-5 h-5"/>
        		</button>
      		</div>
    	</div>


  
    	<!-- ì¢Œì¸¡ ìŠ¬ë¼ì´ë“œ íŒ¨ë„ -->
    	<aside id="shopPanel" 
    	class="fixed top-0 left-36 w-[33vw] h-full bg-white shadow-lg -translate-x-full transition-transform duration-300 z-[2000] overflow-y-auto">

      		<!-- ê²€ìƒ‰ì¹¸ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•¨ -->
      		<div class="p-4 flex justify-between items-center border-b bg-[#FBA62C]">
        		<h2 class="text-lg font-bold">ê°•ë‚¨êµ¬ ì—­ì‚¼1ë™</h2>
        
        		<!-- ì¶”í›„ì— ê²€ìƒ‰ ì¹¸ ì¶”ê°€ -->

        		<!-- ìŠ¬ë¼ì´ë“œ ë‹«ê¸° ë²„íŠ¼ -->
        		<button id="panelClose" class="text-xl w-8 h-8 rounded hover:bg-[#845717]">Ã—</button>
      		</div>
  
      		<!-- JSì—ì„œ ë™ì ìœ¼ë¡œ ë‚´ìš©ì„ ì±„ìš¸ ì˜ì—­ -->
      			<div id="shopContent" class="p-4"></div>
    	</aside>
	</main>

	<!-- ë¦¬ë·° ì´ë¯¸ì§€ í´ë¦­ ì‹œ ì›ë³¸ í¬ê¸°ë¡œ ì‚¬ì§„ ë³¼ ìˆ˜ ìˆëŠ” Lightbox Modal -->
	<!-- Lightbox Modal -->
	<div id="lightbox" class="fixed inset-0 z-[5000] hidden">
  
    	<!-- ë°˜íˆ¬ëª… ë°±ë“œë¡­ -->
    	<div id="lbBackdrop" class="absolute inset-0 bg-black/70"></div>

    	<!-- ì½˜í…ì¸  ë˜í¼ -->
    	<div class="relative w-full h-full grid place-items-center p-4">
    
      		<!-- ë‹«ê¸° ë²„íŠ¼ -->
      		<button id="lbClose" class="absolute top-4 right-4 w-10 h-10 text-2xl 
			bg-white/90 hover:bg-white rounded-full grid place-items-center shadow">Ã—
      		</button>

      		<!-- ì›ë³¸ ì´ë¯¸ì§€ -->
      		<img id="lbImage" alt="ì›ë³¸ ì´ë¯¸ì§€"
			class="w-[90vw] max-h-[85vh] h-auto object-contain rounded shadow-lg border bg-white"/>
    		
			<!-- ìº¡ì…˜ -->
			<div id="lbCaption" class="mt-2 text-white/90 text-sm"></div>
    	</div>
	</div>
  

	<!-- ì¹´ì¹´ì˜¤ ë§µ API ë° ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
	<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0698fb5cbfd3626afb61d071e360de06&libraries=services,clusterer"></script>
	<script>
	/* =========================
	*  ì „ì—­ ì—˜ë¦¬ë¨¼íŠ¸ & ê³µìš© ìƒíƒœ
	* ========================= */
	const panel = document.getElementById('shopPanel');       // ì¢Œì¸¡ ìŠ¬ë¼ì´ë“œ íŒ¨ë„
	const btnClose = document.getElementById('panelClose');   // íŒ¨ë„ ë‹«ê¸° ë²„íŠ¼
	const shopContent = document.getElementById('shopContent'); // íŒ¨ë„ ë‚´ë¶€ ì½˜í…ì¸  ì˜ì—­
	const $status = document.getElementById('status');        // ìƒíƒœ í‘œì‹œ í…ìŠ¤íŠ¸

	/* ================
	*  ì¹´ì¹´ì˜¤ ì§€ë„ ìƒì„±
	* ================ */
	const container = document.getElementById('map');

	//ì§€ë„ë¥¼ ìƒì„±í•  ë•Œ í•„ìš”í•œ ê¸°ë³¸ ì˜µì…˜
	const options = {
		center: new kakao.maps.LatLng(37.5665, 126.9780), // ì´ˆê¹ƒê°’: ì„œìš¸ì‹œì²­
		draggable: true,
		level: 3 //ì§€ë„ì˜ ë ˆë²¨(í™•ëŒ€, ì¶•ì†Œ ì •ë„)
	};

	//ì§€ì˜¤ì½”ë” ê°ì²´ ìƒì„±
	const geocoder = new kakao.maps.services.Geocoder();

	//ì§€ë„ ìƒì„± ë° ê°ì²´ ë¦¬í„´
	const map = new kakao.maps.Map(container, options);

	/* =========================
	*  ì „ì—­ ì¸í¬ìœˆë„ìš° (í•˜ë‚˜ë§Œ ì¬ì‚¬ìš©)
	*  - ë§ˆì»¤ í´ë¦­ ì‹œ ê°€ê²Œëª…ë§Œ í‘œì‹œ
	*  - ì§€ë„ ë¹ˆ ê³³ í´ë¦­ ì‹œ ë‹«í˜
	* ========================= */
	const infoWindow = new kakao.maps.InfoWindow({ removable: true });

	/* =========================
	*  í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ (ì§€ë„ ì¤‘ì‹¬ ì¶”ì )
	* ========================= */
	const myIcon = new kakao.maps.MarkerImage(
		'./assets/pin_icons/pin5.png',
		new kakao.maps.Size(32, 32),
		{ offset: new kakao.maps.Point(16, 32) }
	);
	
	// ê¸°ë³¸ ë§ˆì»¤ ì‚¬ìš©(ì´ë¯¸ì§€ ì œê±° ì›í•˜ë©´ image: myIcon ì‚¬ìš©)
	let currentMarker = new kakao.maps.Marker({
		map,
		position: map.getCenter(),
		zIndex: 999
	});

	/* ==================================================
	*  ì§€ë„ ì´ë™/ì¤Œ ì¢…ë£Œ(idle) â†’ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
	*  + ë””ë°”ìš´ìŠ¤ë¡œ í˜„ì¬ ì§€ì—­ êµ¬ ë³„ë¡œ íŒë³„ & JSON ì¬ë¡œë”©
	* ================================================== */
	let districtDebounce = null;
	let lastDistrict = null;

	kakao.maps.event.addListener(map, 'idle', () => {
		const c = map.getCenter();
		currentMarker.setPosition(c);

		// êµ¬ ìë™ ê°±ì‹ : ë””ë°”ìš´ìŠ¤
		clearTimeout(districtDebounce);
		districtDebounce = setTimeout(resolveDistrictAndReloadByCenter, 400);
	});

	/* =================
	*  ì£¼ì†Œ ë¬¸ìì—´ ìœ í‹¸
	* ================= */
	function cleanNewAddress(addr) {
		if (!addr) return '';
		// "ì„œìš¸" ì•ì˜ ìš°í¸ë²ˆí˜¸/ê³µë°±ì„ ì œê±°
		return addr.replace(/^\d*\s*ì„œìš¸/, 'ì„œìš¸').trim();
	}

	function cleanOldAddress(addr) {
		if (!addr) return '';
		// "525-13 525-13" ê³¼ ê°™ì€ ë²ˆì§€ ì¤‘ë³µ ì œê±°
		return addr.replace(/(\d+-?\d*)\s+\1/, '$1').trim();
	}

	function extractDistrict(addr) {
		if (!addr) return '';
		const m = addr.match(/ì„œìš¸\s+\S+êµ¬/);
		return m ? m[0] : '';
	}

	/* =================
	*  í‰ì  ëœë¤ ìœ í‹¸
	* ================= */

	// 0.0 ~ 5.0 ì‚¬ì´ ê°’(ì†Œìˆ˜ ì²«ì§¸ ìë¦¬) â€” ì˜ˆ: 3.2
	function getRandomRating01dp() {
		// 0~50 ì •ìˆ˜ -> 0.0~5.0 (0.1 ë‹¨ìœ„)
		return Math.round(Math.random() * 50) / 10;
	}

	// ì ìˆ˜ â†’ í•€/í…ìŠ¤íŠ¸ ë³€í™˜ (í•€ì€ ì •ìˆ˜ë¶€ë§Œ ë°˜ì˜)
	function renderRatingView(rating) {
		const intPart = Math.floor(rating);               // í•€ ê°œìˆ˜
		const ratingText = `${rating.toFixed(1)}ì `;      // ìˆ«ì í‘œê¸°(í•­ìƒ 1ìë¦¬ ì†Œìˆ˜)
		const pins = intPart === 0 ? 'í‰ì  0ì  ëŒ€' : 'ğŸ“Œ'.repeat(intPart);
		// í•€ì€ 0ì´ë©´ íšŒìƒ‰, ìˆìœ¼ë©´ ë…¸ë‘
		const pinClass = intPart === 0 ? 'text-gray-500' : 'text-yellow-500';

		return {
			pinHtml: `<span class="${pinClass}">${pins}</span>`,
			numHtml: `<span class="text-sm text-gray-600">${ratingText}</span>`
		};
	}
	/* =========================
	*  ë§¤ì¥(Shop) ì»¤ìŠ¤í…€ ë§ˆì»¤ ìƒì„±
	*  - í´ë¦­ ì‹œ: ì¸í¬ìœˆë„ìš°(ê°€ê²Œëª…) + íŒ¨ë„ ë°”ì¸ë”©
	* ========================= */
	const shopIcon = new kakao.maps.MarkerImage(
		'./assets/pin_icons/pin5.png',
		new kakao.maps.Size(32, 32),
		{ offset: new kakao.maps.Point(16, 32) }
	);

	// ë‹¨ì¼ ë§¤ì¥ ë§ˆì»¤ ìƒì„± + í´ë¦­ í•¸ë“¤ëŸ¬
	function placeMarker(pos, shop) {
	const marker = new kakao.maps.Marker({
		map,
		position: pos,
		title: shop.post_sj,
		image: shopIcon
	});
	// ê°€ê²Œë³„ ëœë¤ ìŒì‹ì¢…ë¥˜(ì„¸ì…˜ ìœ ì§€) â†’ ë§ˆì»¤ ë©”íƒ€ë¡œë„ ë³´ê´€
	const foodKind = getFoodKindFor(shop);
	marker.foodKind = foodKind;
	markers.push(marker);

	// ìƒˆë¡œ ì¶”ê°€ëœ ë§ˆì»¤ë„ í˜„ì¬ í•„í„°ì— ë§ì¶° ì¦‰ì‹œ ë°˜ì˜
	applyFoodFilter(getSelectedFoods());

	kakao.maps.event.addListener(marker, 'click', () => {
		// 1) ì¸í¬ìœˆë„ìš°: ê°€ê²Œëª…ë§Œ í‘œì‹œ
		const content = `
		<div style="padding:6px 10px;font-size:13px;white-space:nowrap;">
			${shop.post_sj || 'ì´ë¦„ ì—†ìŒ'}
		</div>`;
		infoWindow.setContent(content);
		infoWindow.open(map, marker);

		// 2) ì¢Œì¸¡ íŒ¨ë„ ì—´ê¸° + JSON ë°ì´í„° ë°”ì¸ë”©
		panel.classList.remove('-translate-x-full');
		panel.classList.add('translate-x-0');

	// ì ìˆ˜: ê°€ê²Œë§ˆë‹¤ 1íšŒ ìƒì„± í›„ ì¬ì‚¬ìš©(í´ë¦­í•  ë•Œë§ˆë‹¤ ë³€í•˜ì§€ ì•Šê²Œ)
	if (typeof shop._rating !== 'number') {
		shop._rating = getRandomRating01dp();
	}
	const { pinHtml, numHtml } = renderRatingView(shop._rating);
	const rating = shop._rating;
	//const ratingHtml = renderRatingPins(rating);
	const ratingClass = (rating === 0) ? 'text-gray-500' : 'text-yellow-500';

	const foodKind = getFoodKindFor(shop);

	shopContent.innerHTML = `
		<!-- ëŒ€í‘œ ì´ë¯¸ì§€(ê³ ì •) -->
		<div
			class="w-full h-96 rounded-lg bg-gray-200 bg-center bg-contain bg-no-repeat"
			style="background-image: url('./assets/info_assets/main_pic.png');">
		</div>

		<!-- ê°€ê²Œëª… / ì¹´í…Œê³ ë¦¬(ê³ ì •) + ë³„ì (ê³ ì •) -->
		<div class="flex justify-between items-center mt-4">
			<div>
			<h3 class="text-xl font-semibold">${shop.post_sj || 'ì´ë¦„ ì—†ìŒ'}</h3>
			<p class="text-gray-500 text-sm">${foodKind}</p>
			</div>
			<div class="flex items-center gap-2">${pinHtml}${numHtml}</div>

		</div>

		<!-- ì—°ë½ì²˜: ì—†ìœ¼ë©´ 'null' -->
		<p class="flex items-center gap-2">
			<img src="./assets/info_assets/tel_icon.png" alt="ì „í™”" class="w-5 h-5"/>
			${shop.cmmn_telno || 'null'}
		</p>

		<!-- íŒ”ë¡œì›Œ/ë¦¬ë·° ì•ˆë‚´(ê³ ì •) -->
		<div class="text-sm text-gray-600 space-y-1 border-t pt-2 mt-2">
			<p>â™¥ ë‚´ íŒ”ë¡œì›Œ 2ëª…ì´ ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤.</p>
			<p>â— xxxë‹˜ì´ ë¦¬ë·°ë¥¼ ì‘ì„±í•œ ì‹ë‹¹ì…ë‹ˆë‹¤.</p>
		</div>

		<!-- ë¦¬ë·° ì„¹ì…˜(ê³ ì •) -->
		<div class="border-t pt-4 mt-2">
			<div class="flex items-center justify-between mb-2">
				<h4 class="font-semibold">ë¦¬ë·° 112</h4>
				<button class="text-blue-500 text-sm">ë”ë³´ê¸°</button>
			</div>

			<div class="grid grid-cols-3 gap-2" id="reviewGrid">
				<div class="h-40 rounded overflow-hidden">
					<img src="./assets/info_assets/review01.png" alt="ë¦¬ë·°1" class="w-full h-full object-cover">
				</div>
				<div class="h-40 rounded overflow-hidden">
					<img src="./assets/info_assets/review02.png" alt="ë¦¬ë·°2" class="w-full h-full object-cover">
				</div>
				<div class="h-40 rounded overflow-hidden">
					<img src="./assets/info_assets/review03.png" alt="ë¦¬ë·°3" class="w-full h-full object-cover">
				</div>
				<div class="h-40 rounded overflow-hidden">
					<img src="./assets/info_assets/review04.png" alt="ë¦¬ë·°4" class="w-full h-full object-cover">
				</div>
				<div class="h-40 rounded overflow-hidden">
					<img src="./assets/info_assets/review05.png" alt="ë¦¬ë·°5" class="w-full h-full object-cover">
				</div>
			</div>
		</div>`;
		});
	}

	/* =========================================
	*  ì§€ì˜¤ì½”ë”© + 3ë‹¨ê³„ í´ë°±(new â†’ old â†’ ì¡°í•©)
	*  - new_addressê°€ ì‹¤íŒ¨í•˜ë©´ addressë¡œ ì¬ì‹œë„
	* ========================================= */
	function searchAndMark(addr, shop, _type, fallback = null) {
		if (!addr) return fallback && fallback();

		geocoder.addressSearch(addr, (result, status) => {
			if (status === kakao.maps.services.Status.OK && result[0]) {
				const pos = new kakao.maps.LatLng(result[0].y, result[0].x);
				placeMarker(pos, shop);
			} 
			else {
				fallback && fallback();
			}
		});
	}

	function addMarkerWithFallback(shop) {
	const newAddr = cleanNewAddress(shop.new_address || '');
	const oldAddr = cleanOldAddress(shop.address || '');
	const district = extractDistrict(shop.address || '');
	const combined = district && shop.post_sj ? `${district} ${shop.post_sj}` : '';

	// 1) new_address â†’ 2) address â†’ 3) "ì„œìš¸ â—‹â—‹êµ¬ + ìƒí˜¸ëª…"
	searchAndMark(newAddr, shop, 'new_address', () =>
			searchAndMark(oldAddr, shop, 'address', () =>
			searchAndMark(combined, shop, 'district+post_sj')
			)
		);
	}

	/* ===========================
	*  í˜ì´ì§€ë„¤ì´ì…˜ & ë§ˆì»¤ ê´€ë¦¬
	* =========================== */
	let shops = [];                // í˜„ì¬ êµ¬ ì˜ ê°€ê²Œ ëª©ë¡
	let page = 0;                  // í˜„ì¬ í˜ì´ì§€ ì¸ë±ìŠ¤(0ë¶€í„°)
	const pageSize = 20;           // í•œ ë²ˆì— í‘œê¸°í•  ê°œìˆ˜
	const markers = [];            // ìƒì„±ëœ ë§ˆì»¤ ëª¨ìŒ(ì§€ìš°ê¸° ìš©)

	function clearMarkers() {
		markers.forEach(m => m.setMap(null));
		markers.length = 0;
		infoWindow.close();
	}

	function resetPaging() {
		page = 0;
		clearMarkers();
		document.getElementById('loadMore').style.display = 'none';
	}

	function showPage(p) {
		const start = p * pageSize;
		const end = start + pageSize;
		shops.slice(start, end).forEach(shop => addMarkerWithFallback(shop));
	}

	function showNextPage() {
		if (page * pageSize >= shops.length) {
			alert('ë” ì´ìƒ ë¶ˆëŸ¬ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
			return;
		}
		showPage(page++);
	}

	document.getElementById('loadMore').addEventListener('click', showNextPage);

	/* =========================
	*  êµ¬ ë‹¨ìœ„ JSON ë¡œë”©
	* ========================= */
	function loadDistrictJsonAndRender(districtName) {
	const filePath = `./assets/location_seperate/seoul_${districtName}.json`;

	resetPaging();
	fetch(filePath)
		.then(res => {
			if (!res.ok) throw new Error(`JSON ë¡œë“œ ì‹¤íŒ¨: ${res.status}`);
				return res.json();
		})
		.then(data => {
			shops = data.DATA || [];
			$status.textContent = `í˜„ì¬ ì§€ì—­: ì„œìš¸ ${districtName} (ì´ ${shops.length}ê±´)`;
			showNextPage(); // ì²« 20ê°œ
			if (shops.length > pageSize) {
				document.getElementById('loadMore').style.display = 'inline-block';
			}
		})
		.catch(err => {
			console.error(err);
			$status.textContent = `í•´ë‹¹ êµ¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨(ì„œìš¸ ${districtName}). íŒŒì¼/ê²½ë¡œ í™•ì¸ í•„ìš”`;
		});
	}

	/* ==============================
	*  ì—­ì§€ì˜¤ì½”ë”© â†’ í˜„ì¬ êµ¬ íŒë³„ ìš©
	* ============================== */
	function resolveDistrictByLatLng(lat, lng, cb) {
	geocoder.coord2RegionCode(lng, lat, (result, status) => {
		if (status !== kakao.maps.services.Status.OK || !result?.length) return cb(null);
			const info = result.find(r => r.region_type === 'B') || result[0];
			const city = info.region_1depth_name;      // "ì„œìš¸íŠ¹ë³„ì‹œ"
			const district = info.region_2depth_name;  // "ê°•ë‚¨êµ¬" ë“±
		if (!city?.startsWith('ì„œìš¸')) return cb(null);
		cb(district);
	});
	}

	// ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ìœ¼ë¡œ êµ¬ íŒë³„ â†’ ë°”ë€Œë©´ JSON ì¬ë¡œë”©
	function resolveDistrictAndReloadByCenter() {
	const c = map.getCenter();
	resolveDistrictByLatLng(c.getLat(), c.getLng(), (district) => {
		if (!district) return;
		if (district !== lastDistrict) {
		lastDistrict = district;
		$status.textContent = `í˜„ì¬ ìœ„ì¹˜: ì„œìš¸ ${district} (í•´ë‹¹ êµ¬ ë°ì´í„° ë¡œë“œ ì¤‘â€¦)`;
		loadDistrictJsonAndRender(district);
		}
	});
	}

	/* ====================
	*  ì´ˆê¸° ìœ„ì¹˜ ì²˜ë¦¬
	* ==================== */
	if ('geolocation' in navigator) {
	navigator.geolocation.getCurrentPosition(
		(pos) => {
			const lat = pos.coords.latitude;
			const lng = pos.coords.longitude;
			const center = new kakao.maps.LatLng(lat, lng);

			map.setCenter(center);
			map.setLevel(6);
			currentMarker.setPosition(center); // ì´ˆê¸° ì„¤ì • ì‹œ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ ë™ê¸°í™”
			$status.textContent = 'í˜„ì¬ ìœ„ì¹˜ í™•ì¸ ì™„ë£Œ. êµ¬ ì‹ë³„ ì¤‘â€¦';

			resolveDistrictByLatLng(lat, lng, (district) => {
				if (!district) {
					$status.textContent = 'ì„œìš¸ ì™¸ ì§€ì—­ì…ë‹ˆë‹¤. ì§€ë„ë¥¼ ì´ë™í•´ ì£¼ì„¸ìš”.';
					return;
				}
				lastDistrict = district;
				loadDistrictJsonAndRender(district);
				});
			},
			(err) => {
				console.warn('Geolocation ì‹¤íŒ¨:', err);
				$status.textContent = 'ìœ„ì¹˜ ê¶Œí•œ ê±°ë¶€ë¨. ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ìœ¼ë¡œ êµ¬ë¥¼ ì‹ë³„í•©ë‹ˆë‹¤.';
				// ì§€ë„ ì¤‘ì‹¬ìœ¼ë¡œ êµ¬ íŒë³„
				resolveDistrictAndReloadByCenter();
			},
			{ enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
		);
	} else {
		$status.textContent = 'ë¸Œë¼ìš°ì €ê°€ ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
		resolveDistrictAndReloadByCenter();
	}

	/* =========================
	*  ì§€ë„ ì»¨íŠ¸ë¡¤(ì¤Œ/í˜„ì¬ ìœ„ì¹˜)
	* ========================= */
	document.getElementById('zoomIn').addEventListener('click', () => {
		const level = map.getLevel();
		if (level > 1) map.setLevel(level - 1);
	});

	document.getElementById('zoomOut').addEventListener('click', () => {
		const level = map.getLevel();
		map.setLevel(level + 1);
	});

	// í˜„ì¬ ìœ„ì¹˜ë¡œ ì§€ë„ ì´ë™ + ë§ˆì»¤ í‘œì‹œ (ê³µìš© í•¨ìˆ˜)
	function goToCurrentLocation() {
		if (!navigator.geolocation) {
			console.warn("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìœ„ì¹˜ ì •ë³´ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
			return;
	}
	navigator.geolocation.getCurrentPosition(
		(pos) => {
			const lat = pos.coords.latitude;
			const lng = pos.coords.longitude;
			const loc = new kakao.maps.LatLng(lat, lng);

			// ì´ë¯¸ ë§Œë“¤ì–´ë‘” currentMarkerë§Œ ì´ë™/í‘œì‹œ (ë¶ˆí•„ìš”í•œ ì¬ìƒì„± ì œê±°)
			currentMarker.setPosition(loc);
			currentMarker.setMap(map);

			map.setCenter(loc);
			map.setLevel(3);
		},
		(err) => {
			console.warn("í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (" + err.message + ")");
		},
		{ enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
		);
	}

	document.getElementById('currentLocationBtn').addEventListener('click', goToCurrentLocation);
	window.addEventListener('DOMContentLoaded', goToCurrentLocation); // ì´ˆê¸° ì´ë™
	

	/* =========================
	*  ìŒì‹ ë²„íŠ¼(ë‹¤ì¤‘ í† ê¸€)
	*  - í•„í„° ë¡œì§ì€ ì•„ì§ ì¡´ì¬x
	* ========================= */
	const FOOD_KINDS = ['í•œì‹', 'ì¤‘ì‹', 'ì–‘ì‹', 'ì¼ì‹', 'ë¶„ì‹'];

	// ì´ í˜ì´ì§€ ì„¸ì…˜ì—ì„œ ê°€ê²Œë³„ë¡œ ê³ ì • ìœ ì§€ (ìƒˆë¡œê³ ì¹¨ ì „ê¹Œì§€)
	const foodKindStore = new Map();

	function pickRandomFoodKind() {
		return FOOD_KINDS[Math.floor(Math.random() * FOOD_KINDS.length)];
	}

	// ê°€ê²Œë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì‹ë³„í•  í‚¤ (ì´ë¦„ + ì£¼ì†Œ ê¸°ë°˜)
	function getShopKey(shop) {
		return `${shop.post_sj || 'NO_NAME'}|${shop.address || shop.new_address || ''}`.trim();
	}

	// ê°€ê²Œë³„ ìŒì‹ ì¢…ë¥˜ ê°€ì ¸ì˜¤ê¸°(ì—†ìœ¼ë©´ ëœë¤ ìƒì„± í›„ ì €ì¥)
	function getFoodKindFor(shop) {
		const key = getShopKey(shop);
		let kind = foodKindStore.get(key);
		if (!kind) {
			kind = pickRandomFoodKind();
			foodKindStore.set(key, kind);
		}
		// ìºì‹œë¥¼ shop ê°ì²´ì—ë„ ë¶™ì—¬ë‘ë©´ í…œí”Œë¦¿ì—ì„œ ë°”ë¡œ ì ‘ê·¼ ê°€ëŠ¥
		shop._foodKind = kind;
		return kind;
	}
	// ë²„íŠ¼ ì´ˆê¸°í™”: labelì„ data-keyë¡œ ë°•ì•„ë‘ë©´ ì•ˆì „
	document.querySelectorAll('.food-btn').forEach(btn => {
		const labelEl = btn.querySelector('span:last-child');
		if (labelEl) btn.dataset.key = labelEl.textContent.trim();
	});

	//	const foodBtns = document.querySelectorAll('.food-btn');
	//	foodBtns.forEach(btn => {
	//		btn.addEventListener('click', () => {
	//		const isActive = btn.getAttribute('aria-pressed') === 'true';
	//		btn.setAttribute('aria-pressed', String(!isActive));
	//		// TODO: applyFoodFilter(getSelectedFoods());
	//		});
	//	});


	// í˜„ì¬ í™œì„± ì¹´í…Œê³ ë¦¬ ëª©ë¡
	function getSelectedFoods() {
		return Array.from(document.querySelectorAll('.food-btn[aria-pressed="true"]'))
			.map(b => b.dataset.key || b.textContent.trim());
	}
	// í•µì‹¬: í•„í„° ì ìš©
	function applyFoodFilter(selected) {
		const active = (selected || []).filter(Boolean);
		// ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ â†’ ì „ì²´ ë³´ì´ê¸°
		if (active.length === 0) {
			markers.forEach(m => m.setMap(map));
			return;
		}
		// í™œì„± ëª©ë¡ì— í¬í•¨ëœ ì¹´í…Œê³ ë¦¬ë§Œ ë³´ì´ê¸°
		markers.forEach(m => {
			const show = active.includes(m.foodKind);
			m.setMap(show ? map : null);
		});

		// ê°€ë ¤ì§ˆ ìˆ˜ ìˆìœ¼ë‹ˆ, UXì ìœ¼ë¡œ ì¸í¬ìœˆë„ìš°/íŒ¨ë„ì€ ë‹«ì•„ì£¼ëŠ” í¸ì´ ìì—°ìŠ¤ëŸ¬ì›€(ì„ íƒ)
		infoWindow.close();
		panel.classList.remove('translate-x-0');
		panel.classList.add('-translate-x-full');
	}

	// ë²„íŠ¼ í† ê¸€ + í•„í„° ë°˜ì˜
	document.querySelectorAll('.food-btn').forEach(btn => {
		btn.addEventListener('click', () => {
			const isActive = btn.getAttribute('aria-pressed') === 'true';
			btn.setAttribute('aria-pressed', String(!isActive));
			applyFoodFilter(getSelectedFoods());
		});
	});
	/* =========================
	*  ì¢Œì¸¡ ì‚¬ì´ë“œ íƒ­ í™œì„± í† ê¸€
	* ========================= */
	function setActiveTab(tabName) {
	document.querySelectorAll('.side-btn').forEach(btn => {
		if (btn.dataset.tab === tabName) btn.setAttribute('aria-current', 'page');
		else btn.removeAttribute('aria-current');
	});
	}
	setActiveTab('map'); // ì´ í˜ì´ì§€ëŠ” mapì´ë¼ê³  ì•Œë¦¬ëŠ” í•¨ìˆ˜

	/* =========================
	*  íŒ¨ë„ ë‹«ê¸°(ë²„íŠ¼/ESC/ì§€ë„ í´ë¦­)
	*  + ì§€ë„ í´ë¦­ ì‹œ ì¸í¬ìœˆë„ìš°ë„ ë‹«ìŒ
	* ========================= */

	// ë²„íŠ¼ìœ¼ë¡œ ì¢Œì¸¡ ìŠ¬ë¼ì´ë“œ ë‹«ê¸°
	btnClose?.addEventListener('click', () => {
		panel.classList.remove('translate-x-0');
		panel.classList.add('-translate-x-full');
	});

	// ESCë¡œ ì¢Œì¸¡ ìŠ¬ë¼ì´ë“œ ë‹«ê¸°
	window.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') {
			panel.classList.remove('translate-x-0');
			panel.classList.add('-translate-x-full');
		}
	});

	// ì§€ë„ í´ë¦­ ì‹œ ì¢Œì¸¡ ìŠ¬ë¼ì´ë“œ ë‹«ê¸°
	kakao.maps.event.addListener(map, 'click', () => {
		panel.classList.remove('translate-x-0');
		panel.classList.add('-translate-x-full');
		infoWindow.close(); // ì§€ë„ ë¹ˆ ê³³ í´ë¦­ â†’ ì¸í¬ìœˆë„ìš° ë‹«ê¸°
	});

	/* =========================
	*  Lightbox (ë¦¬ë·° ì´ë¯¸ì§€ í™•ëŒ€)
	* ========================= */
	const lightbox   = document.getElementById('lightbox');
	const lbImg      = document.getElementById('lbImage');
	const lbCaption  = document.getElementById('lbCaption');
	const lbClose    = document.getElementById('lbClose');
	const lbBackdrop = document.getElementById('lbBackdrop');

	function openLightbox(src, caption = '') {
		lbImg.src = src;
		lbCaption.textContent = caption;
		lightbox.classList.remove('hidden');
		document.body.style.overflow = 'hidden'; // ìŠ¤í¬ë¡¤ ì ê¸ˆ
	}

	function closeLightbox() {
		lightbox.classList.add('hidden');
		lbImg.src = '';
		lbCaption.textContent = '';
		document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µêµ¬
	}

	lbClose.addEventListener('click', closeLightbox);
	lbBackdrop.addEventListener('click', closeLightbox);
	window.addEventListener('keydown', (e) => {
		if (e.key === 'Escape') closeLightbox();
	});

	// ì´ë²¤íŠ¸ ìœ„ì„: íŒ¨ë„ ë‚´ ë¦¬ë·° ì¸ë„¤ì¼ í´ë¦­ ì‹œ ë¼ì´íŠ¸ë°•ìŠ¤ ì˜¤í”ˆ
	// ë‹¤ë§Œ, ì´ë¯¸ì§€ ë¹„ìœ¨ì´ ë¶€ì •í™•í•¨. ê°œì„ ì´ í•„ìš”í• ë“¯?
	document.getElementById('shopPanel').addEventListener('click', (e) => {
		const img = e.target.closest('#shopContent img');
		if (!img) return;
		const fullSrc = img.getAttribute('data-full') || img.src;
		openLightbox(fullSrc, img.alt || '');
	});
	</script>

</body>
</html>
